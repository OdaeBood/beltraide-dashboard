import React, { useMemo, useState, useRef, useEffect } from "react";
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  LineChart,
  Line,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Legend,
} from "recharts";
import ForceGraph2D from "react-force-graph-2d";

/**
 * -------------------------------------------------------------
 *  LUNA MAPS — BELTRAIDE Cooperatives Dashboard (Single-file Build)
 * -------------------------------------------------------------
 *  Fixes & features (stable build):
 *   - ✅ Fixes SyntaxError: Unterminated string constant (properly closed JSX at end of file)
 *   - ✅ Ecosystem Graph with drag-to-resize (bottom-right, grey, transparent)
 *   - ✅ Auto center / zoomToFit once on load and after dataset size changes (without blocking interaction)
 *   - ✅ Sector hub click → apply filter + smooth scroll (Step A)
 *   - ✅ Sector Summary panel (KPIs + mini charts) (Step B)
 *   - ✅ FDI priorities added as hub nodes + click to filter
 *   - ✅ Sector dropdown limited to Blue Economy (Seaweed, Aquaculture, Eco-tourism, Fisheries)
 *   - ✅ Self-tests intact + added a couple more
 * -------------------------------------------------------------
 */

// THEME -------------------------------------------------------
const LUNA = {
  bg: "#0D0D0D",
  panel: "#151515",
  text: "#FFFFFF",
  textMuted: "#A3A3A3",
  gold: "#F9C74F",
  orange: "#F9844A",
  soft: "#FFD166",
  border: "#262626",
};
const cx = (...cls: (string | false | null | undefined)[]) => cls.filter(Boolean).join(" ");

// Lightweight UI (no external UI libs) -----------------------
const Card: React.FC<any> = ({ children, className, style }) => (
  <div className={cx("rounded-2xl border overflow-hidden", className)} style={{ borderColor: LUNA.border, background: LUNA.panel, ...style }}>{children}</div>
);
const CardHeader: React.FC<any> = ({ children, className }) => (
  <div className={cx("px-4 py-3 border-b", className)} style={{ borderColor: LUNA.border }}>{children}</div>
);
const CardTitle: React.FC<any> = ({ children, className }) => (
  <div className={cx("text-white font-semibold", className)}>{children}</div>
);
const CardContent: React.FC<any> = ({ children, className }) => (
  <div className={cx("p-4", className)}>{children}</div>
);
const Button: React.FC<any> = ({ children, onClick, variant = "primary", className }) => (
  <button
    onClick={onClick}
    className={cx(
      "rounded-xl px-3 py-2 text-sm transition",
      variant === "primary" && "bg-[#F9C74F] text-black hover:opacity-90",
      variant === "secondary" && "bg-[#FFD166] text-black hover:opacity-90",
      variant === "outline" && "border border-[#262626] text-white hover:bg-[#1b1b1b]",
      variant === "ghost" && "text-zinc-400 hover:text-white",
      className
    )}
  >
    {children}
  </button>
);
const Input: React.FC<any> = ({ className, ...props }) => (
  <input {...props} className={cx("w-full rounded-xl bg-[#151515] border border-[#262626] px-3 py-2 text-sm text-white placeholder:text-zinc-500", className)} />
);
const SelectBox: React.FC<any> = ({ value, onChange, placeholder, options, className }) => (
  <select
    value={value || ""}
    onChange={(e) => onChange?.(e.target.value || undefined)}
    className={cx("w-full rounded-xl bg-[#151515] border border-[#262626] px-3 py-2 text-sm text-white", !value && "text-zinc-500", className)}
  >
    <option value="">{placeholder || "Select"}</option>
    {options.map((o: string) => (
      <option key={o} value={o} className="text-white">
        {o}
      </option>
    ))}
  </select>
);
const Badge: React.FC<any> = ({ children, className }) => (
  <span className={cx("inline-flex items-center rounded-md px-2 py-1 text-xs font-medium", className)}>{children}</span>
);
const Separator: React.FC<any> = ({ className }) => <hr className={cx("border-0 h-px w-full", className)} style={{ background: LUNA.border }} />;

// DATA: Cooperatives (Beltraide) ------------------------------
export type Cooperative = {
  id: string;
  cooperativeName: string; // Cooperative Name
  officialName: string; // Official name of cooperative
  district: string; // Location (District)
  gps: string; // GPS string "lat,lon"
  sector: string; // Sector Classification
  valueChain: "Producer" | "Processor" | "Exporter";
  buyer: string; // Linked Buyer / Export Partner
  members: number; // Membership Size
  capacity: number; // Production Capacity (Annual) numeric
  capacityUnit: string; // units (tons, kg, units)
  product: string; // Product Focus
  certifications: string[]; // Certifications
  exportHistory: ("Local" | "Regional" | "International")[]; // Export History
  fdiPriority: string; // FDI Priority Alignment
  esg: string[]; // ESG/SDG Contributions
  partners: string[]; // Supporting Projects / Partners
  contact: string; // Contact Info
};

const DISTRICTS = ["Belize", "Cayo", "Corozal", "Orange Walk", "Stann Creek", "Toledo"];
const SECTORS = ["Seaweed", "Aquaculture", "Eco-tourism", "Cacao", "Honey", "Fisheries"];
const BLUE_SECTORS = ["Seaweed", "Aquaculture", "Eco-tourism", "Fisheries"]; // Focus: Blue Economy
const VALUE_CHAIN: Cooperative["valueChain"][] = ["Producer", "Processor", "Exporter"];
const FDI_PRIORITIES = ["Blue Economy", "Sustainable Tourism", "Agribusiness & Fisheries", "BPO/ICT", "Renewable Energy"];
const CERTS = ["Organic", "Fair Trade", "HACCP", "ISO 22000", "MSC"];
const ESG_TAGS = ["Climate", "Biodiversity", "Community", "Youth", "Gender"];

const COOPS: Cooperative[] = [
  {
    id: "co1",
    cooperativeName: "Sea Bloom",
    officialName: "Sea Bloom Cooperative",
    district: "Stann Creek",
    gps: "16.90,-88.20",
    sector: "Seaweed",
    valueChain: "Producer",
    buyer: "Belize Sea Co.",
    members: 45,
    capacity: 12,
    capacityUnit: "tons",
    product: "Raw seaweed",
    certifications: ["Organic"],
    exportHistory: ["Local"],
    fdiPriority: "Blue Economy",
    esg: ["Climate", "Community"],
    partners: ["NGO A"],
    contact: "lead@seabloom.bz | +501 555-1001",
  },
  {
    id: "co2",
    cooperativeName: "Coral Care",
    officialName: "Coral Care Marine Cooperative",
    district: "Toledo",
    gps: "16.20,-88.81",
    sector: "Aquaculture",
    valueChain: "Processor",
    buyer: "Blue Foods Ltd.",
    members: 60,
    capacity: 6000,
    capacityUnit: "kg",
    product: "Sea cucumber (semi-processed)",
    certifications: ["HACCP"],
    exportHistory: ["Regional"],
    fdiPriority: "Agribusiness & Fisheries",
    esg: ["Biodiversity", "Community"],
    partners: ["Donor X", "Tech Assist Y"],
    contact: "info@coralcare.org | +501 555-1002",
  },
  {
    id: "co3",
    cooperativeName: "Maya Cacao",
    officialName: "Maya Mountain Cacao Cooperative",
    district: "Toledo",
    gps: "16.27,-88.78",
    sector: "Cacao",
    valueChain: "Producer",
    buyer: "ChocoBel Exporters",
    members: 120,
    capacity: 90,
    capacityUnit: "tons",
    product: "Fermented cacao beans",
    certifications: ["Organic", "Fair Trade"],
    exportHistory: ["International"],
    fdiPriority: "Agribusiness & Fisheries",
    esg: ["Biodiversity", "Community", "Youth"],
    partners: ["NGO C", "Donor Z"],
    contact: "maya.cacao@coop.bz | +501 555-1003",
  },
  {
    id: "co4",
    cooperativeName: "Belize HoneyWorks",
    officialName: "Belize HoneyWorks Cooperative",
    district: "Cayo",
    gps: "17.09,-89.06",
    sector: "Honey",
    valueChain: "Processor",
    buyer: "SweetBel Imports",
    members: 80,
    capacity: 40,
    capacityUnit: "tons",
    product: "Filtered honey | value-added",
    certifications: ["Organic", "ISO 22000"],
    exportHistory: ["Regional", "International"],
    fdiPriority: "Agribusiness & Fisheries",
    esg: ["Biodiversity", "Community", "Gender"],
    partners: ["NGO BeeLab"],
    contact: "hello@honeyworks.bz | +501 555-1004",
  },
  {
    id: "co5",
    cooperativeName: "Barrier Reef Tours",
    officialName: "Barrier Reef Eco-Tourism Cooperative",
    district: "Belize",
    gps: "17.50,-88.19",
    sector: "Eco-tourism",
    valueChain: "Exporter",
    buyer: "Global Travel Partners",
    members: 55,
    capacity: 15000,
    capacityUnit: "units",
    product: "Eco-tour packages",
    certifications: ["ISO 22000"],
    exportHistory: ["International"],
    fdiPriority: "Sustainable Tourism",
    esg: ["Climate", "Community"],
    partners: ["Tourism Board", "Donor Q"],
    contact: "ops@brt.bz | +501 555-1005",
  },
  {
    id: "co6",
    cooperativeName: "Lagoon Fishers",
    officialName: "Lagoon Fishers Cooperative",
    district: "Corozal",
    gps: "18.40,-88.39",
    sector: "Fisheries",
    valueChain: "Producer",
    buyer: "BelSea Export",
    members: 200,
    capacity: 180,
    capacityUnit: "tons",
    product: "Fin fish (raw)",
    certifications: ["MSC"],
    exportHistory: ["Local", "Regional"],
    fdiPriority: "Blue Economy",
    esg: ["Climate", "Community"],
    partners: ["NGO FishAid", "Donor Net"],
    contact: "board@lagoonfishers.coop | +501 555-1006",
  },
  {
    id: "co7",
    cooperativeName: "Orange Walk Aqua",
    officialName: "Orange Walk Aquaculture Cooperative",
    district: "Orange Walk",
    gps: "18.08,-88.56",
    sector: "Aquaculture",
    valueChain: "Exporter",
    buyer: "MarSea Intl",
    members: 95,
    capacity: 85,
    capacityUnit: "tons",
    product: "Shrimp (value-added)",
    certifications: ["HACCP", "ISO 22000"],
    exportHistory: ["International"],
    fdiPriority: "Agribusiness & Fisheries",
    esg: ["Climate", "Biodiversity"],
    partners: ["Tech Assist Aqua"],
    contact: "contact@owaq.org | +501 555-1007",
  },
  {
    id: "co8",
    cooperativeName: "Cayo Trails",
    officialName: "Cayo Community Trails Cooperative",
    district: "Cayo",
    gps: "17.25,-88.78",
    sector: "Eco-tourism",
    valueChain: "Producer",
    buyer: "Green Journeys",
    members: 30,
    capacity: 6000,
    capacityUnit: "units",
    product: "Community-led tours",
    certifications: ["Fair Trade"],
    exportHistory: ["Regional"],
    fdiPriority: "Sustainable Tourism",
    esg: ["Community", "Youth"],
    partners: ["NGO Trails"],
    contact: "bookings@cayotrails.bz | +501 555-1008",
  },
];

// FILTERS -----------------------------------------------------
export type CoopFilters = {
  q: string;
  sector?: string;
  valueChain?: Cooperative["valueChain"]; 
  district?: string;
  buyer?: string;
  certification?: string;
  fdiPriority?: string;
  esg?: string; // single tag match
  exportHistory?: "Local" | "Regional" | "International";
  minMembers: number;
  maxMembers: number;
  minCapacity: number;
  maxCapacity: number;
};

const defaultCoopFilters = (): CoopFilters => ({
  q: "",
  minMembers: 0,
  maxMembers: 1000,
  minCapacity: 0,
  maxCapacity: 20000,
});

export function filterCoops(list: Cooperative[], f: CoopFilters): Cooperative[] {
  return list.filter((c) => {
    if (f.q) {
      const q = f.q.toLowerCase();
      const txt = [
        c.cooperativeName,
        c.officialName,
        c.sector,
        c.valueChain,
        c.district,
        c.buyer,
        c.product,
        c.fdiPriority,
        c.contact,
        c.partners.join(" "),
        c.certifications.join(" "),
      ]
        .join(" ")
        .toLowerCase();
      if (!txt.includes(q)) return false;
    }
    if (f.sector && c.sector !== f.sector) return false;
    if (f.valueChain && c.valueChain !== f.valueChain) return false;
    if (f.district && c.district !== f.district) return false;
    if (f.buyer && c.buyer !== f.buyer) return false;
    if (f.certification && !c.certifications.includes(f.certification)) return false;
    if (f.fdiPriority && c.fdiPriority !== f.fdiPriority) return false;
    if (f.esg && !c.esg.includes(f.esg)) return false;
    if (f.exportHistory && !c.exportHistory.includes(f.exportHistory)) return false;
    if (c.members < f.minMembers || c.members > f.maxMembers) return false;
    if (c.capacity < f.minCapacity || c.capacity > f.maxCapacity) return false;
    return true;
  });
}

// EXPORT ------------------------------------------------------
function exportCSV(rows: Cooperative[]) {
  const header = [
    "Cooperative Name",
    "Official Name",
    "District",
    "GPS",
    "Sector",
    "Value Chain",
    "Linked Buyer",
    "Membership Size",
    "Production Capacity",
    "Capacity Unit",
    "Product Focus",
    "Certifications",
    "Export History",
    "FDI Priority",
    "ESG/SDG",
    "Partners",
    "Contact",
  ];
  const lines = [header.join(",")].concat(
    rows.map((r) =>
      [
        r.cooperativeName,
        r.officialName,
        r.district,
        r.gps,
        r.sector,
        r.valueChain,
        r.buyer,
        r.members,
        r.capacity,
        r.capacityUnit,
        r.product,
        r.certifications.join("|"),
        r.exportHistory.join("|"),
        r.fdiPriority,
        r.esg.join("|"),
        r.partners.join("|"),
        r.contact,
      ].join(",")
    )
  );
  const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "beltraide_cooperatives.csv";
  a.click();
  URL.revokeObjectURL(url);
}

// FILTERS PANEL -----------------------------------------------
const FiltersPanel: React.FC<{ filters: CoopFilters; setFilters: (f: CoopFilters) => void; allBuyers: string[] }> = ({
  filters,
  setFilters,
  allBuyers,
}) => {
  const set = (patch: Partial<CoopFilters>) => setFilters({ ...filters, ...patch });
  return (
    <div className="space-y-4">
      <div className="flex items-center gap-2">
        <span>🔎</span>
        <span className="text-sm text-zinc-400">Filters</span>
      </div>

      <Input placeholder="Search name, sector, partner, etc." value={filters.q} onChange={(e) => set({ q: e.target.value })} />

      <div className="grid grid-cols-2 gap-2">
        <SelectBox placeholder="Sector" value={filters.sector} onChange={(v: string) => set({ sector: v })} options={BLUE_SECTORS} />
        <SelectBox placeholder="Value Chain" value={filters.valueChain} onChange={(v: string) => set({ valueChain: v })} options={VALUE_CHAIN} />
        <SelectBox placeholder="District" value={filters.district} onChange={(v: string) => set({ district: v })} options={DISTRICTS} />
        <SelectBox placeholder="FDI Priority" value={filters.fdiPriority} onChange={(v: string) => set({ fdiPriority: v })} options={FDI_PRIORITIES} />
        <SelectBox placeholder="Certification" value={filters.certification} onChange={(v: string) => set({ certification: v })} options={CERTS} />
        <SelectBox placeholder="ESG Tag" value={filters.esg} onChange={(v: string) => set({ esg: v })} options={ESG_TAGS} />
        <SelectBox placeholder="Export History" value={filters.exportHistory} onChange={(v: string) => set({ exportHistory: v })} options={["Local", "Regional", "International"]} />
        <SelectBox placeholder="Buyer" value={filters.buyer} onChange={(v: string) => set({ buyer: v })} options={allBuyers} />
      </div>

      <div>
        <div className="text-xs text-zinc-400 mb-1">Capacity Range</div>
        <div className="grid grid-cols-2 gap-2">
          <Input type="number" value={filters.minCapacity} onChange={(e) => set({ minCapacity: Number(e.target.value) })} placeholder="Min" />
          <Input type="number" value={filters.maxCapacity} onChange={(e) => set({ maxCapacity: Number(e.target.value) })} placeholder="Max" />
        </div>
      </div>

      <div className="flex gap-2 pt-2">
        <Button variant="secondary" onClick={() => setFilters(defaultCoopFilters())}>Reset</Button>
        <Button variant="outline">Save View</Button>
      </div>
    </div>
  );
};

// TABLE -------------------------------------------------------
const CoopTable: React.FC<{ data: Cooperative[]; onSelect: (id: string) => void }> = ({ data, onSelect }) => (
  <div className="rounded-2xl border" style={{ borderColor: LUNA.border }}>
    <div className="grid grid-cols-10 text-[12px] px-4 py-2 text-zinc-400" style={{ background: "#111" }}>
      <div>Cooperative</div>
      <div>District</div>
      <div>Sector</div>
      <div>Value Chain</div>
      <div>Buyer</div>
      <div className="text-right">Members</div>
      <div className="text-right">Capacity</div>
      <div>Product</div>
      <div>Certs</div>
      <div>Export</div>
    </div>
    <div className="max-h-[300px] overflow-auto">
      {data.map((c) => (
        <div
          key={c.id}
          className="grid grid-cols-10 px-4 py-3 items-center hover:bg-[#151515] cursor-pointer text-sm"
          style={{ borderTop: `1px solid ${LUNA.border}` }}
          onClick={() => onSelect(c.id)}
        >
          <div className="font-medium text-white">{c.cooperativeName}</div>
          <div className="text-zinc-300">{c.district}</div>
          <div className="text-zinc-300">{c.sector}</div>
          <div className="text-zinc-300">{c.valueChain}</div>
          <div className="text-zinc-300 truncate">{c.buyer}</div>
          <div className="text-right text-zinc-200">{c.members}</div>
          <div className="text-right text-zinc-200">{c.capacity} {c.capacityUnit}</div>
          <div className="text-zinc-300 truncate">{c.product}</div>
          <div className="text-zinc-300 truncate">{c.certifications.join("/")}</div>
          <div className="text-zinc-300">{c.exportHistory.join("/")}</div>
        </div>
      ))}
    </div>
  </div>
);

// DETAILS -----------------------------------------------------
const CoopDetailPanel: React.FC<{ selected?: Cooperative; onClear: () => void }> = ({ selected, onClear }) => {
  if (!selected)
    return (
      <Card>
        <CardHeader>
          <CardTitle className="text-sm">Select a cooperative</CardTitle>
        </CardHeader>
        <CardContent className="text-sm text-zinc-400">Click a row to view detailed information, ESG alignment, partners, and contacts.</CardContent>
      </Card>
    );

  return (
    <Card>
      <CardHeader className="flex items-center justify-between">
        <CardTitle className="text-sm">{selected.officialName}</CardTitle>
        <Button variant="ghost" onClick={onClear}>✖</Button>
      </CardHeader>
      <CardContent className="space-y-3 text-sm">
        <div className="flex gap-2 flex-wrap">
          <Badge className="bg-[#F9C74F] text-black">{selected.sector}</Badge>
          <Badge className="bg-[#F9844A] text-black">{selected.valueChain}</Badge>
          <Badge className="bg-[#222] text-zinc-300">{selected.district}</Badge>
        </div>
        <div className="grid grid-cols-2 gap-3">
          <Stat label="Cooperative" value={selected.cooperativeName} />
          <Stat label="Buyer/Partner" value={selected.buyer} />
          <Stat label="Members" value={selected.members} />
          <Stat label="Capacity" value={`${selected.capacity} ${selected.capacityUnit}`} />
          <Stat label="FDI Priority" value={selected.fdiPriority} />
          <Stat label="GPS" value={selected.gps} />
        </div>
        <Separator />
        <div>
          <div className="text-zinc-400 mb-1">Product Focus</div>
          <div className="text-white">{selected.product}</div>
        </div>
        <div>
          <div className="text-zinc-400 mb-1">Certifications</div>
          <div className="flex gap-2 flex-wrap">
            {selected.certifications.map((i) => (
              <Badge key={i} className="bg-[#FFD166] text-black">{i}</Badge>
            ))}
          </div>
        </div>
        <div>
          <div className="text-zinc-400 mb-1">Export History</div>
          <div className="flex gap-2 flex-wrap">
            {selected.exportHistory.map((i) => (
              <Badge key={i} className="bg-[#333] text-zinc-300">{i}</Badge>
            ))}
          </div>
        </div>
        <div>
          <div className="text-zinc-400 mb-1">ESG / SDG Contributions</div>
          <div className="flex gap-2 flex-wrap">
            {selected.esg.map((i) => (
              <Badge key={i} className="bg-[#0e1f12] text-[#8ddf96] border border-[#1f3b26]">{i}</Badge>
            ))}
          </div>
        </div>
        <div>
          <div className="text-zinc-400 mb-1">Supporting Projects / Partners</div>
          <div className="flex gap-2 flex-wrap">
            {selected.partners.map((i) => (
              <Badge key={i} className="bg-[#1b1b1b] text-zinc-300 border border-[#262626]">{i}</Badge>
            ))}
          </div>
        </div>
        <div className="flex gap-2 pt-2">
          <Button onClick={() => exportCSV([selected])}>Export</Button>
          <Button variant="outline">Share</Button>
        </div>
        <div className="text-zinc-300">Contact: {selected.contact}</div>
      </CardContent>
    </Card>
  );
};

const Stat: React.FC<{ label: string; value: React.ReactNode }> = ({ label, value }) => (
  <div>
    <div className="text-xs text-zinc-400">{label}</div>
    <div className="text-white text-lg font-semibold">{value}</div>
  </div>
);

// SECTOR SUMMARY PANEL ---------------------------------------
const SectorSummaryPanel: React.FC<{ sector: string; data: Cooperative[] }> = ({ sector, data }) => {
  const totalCoops = data.length;

  const vc = useMemo(() => {
    const map: Record<Cooperative["valueChain"], number> = { Producer: 0, Processor: 0, Exporter: 0 };
    data.forEach(d => { map[d.valueChain] = (map[d.valueChain] || 0) + 1; });
    return map;
  }, [data]);

  const capacityByUnit = useMemo(() => {
    const m = new Map<string, number>();
    data.forEach(d => m.set(d.capacityUnit, (m.get(d.capacityUnit) || 0) + d.capacity));
    return Array.from(m, ([unit, value]) => ({ unit, value }));
  }, [data]);

  const byDistrict = useMemo(() => {
    const m = new Map<string, number>();
    data.forEach(d => m.set(d.district, (m.get(d.district) || 0) + 1));
    return Array.from(m, ([district, count]) => ({ district, count }));
  }, [data]);

  const exportMix = useMemo(() => {
    const m = new Map<string, number>([["Local", 0], ["Regional", 0], ["International", 0]]);
    data.forEach(d => d.exportHistory.forEach(e => m.set(e, (m.get(e) || 0) + 1)));
    return Array.from(m, ([name, value]) => ({ name, value }));
  }, [data]);

  const topBuyers = useMemo(() => {
    const m = new Map<string, number>();
    data.forEach(d => m.set(d.buyer, (m.get(d.buyer) || 0) + 1));
    return Array.from(m, ([buyer, count]) => ({ buyer, count })).sort((a,b) => b.count - a.count).slice(0, 5);
  }, [data]);

  const pieColors = [LUNA.gold, LUNA.orange, LUNA.soft];

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-sm">🌊 Sector Summary — {sector}</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4 text-sm">
        <div className="grid grid-cols-3 gap-3">
          <Stat label="Cooperatives" value={totalCoops} />
          <Stat label="Value Chain" value={`P:${vc.Producer || 0} / Pr:${vc.Processor || 0} / E:${vc.Exporter || 0}`} />
          <div>
            <div className="text-xs text-zinc-400">Capacity (by unit)</div>
            <div className="text-white font-semibold">
              {capacityByUnit.length ? capacityByUnit.map((r, i) => (
                <span key={r.unit}>{i ? ", " : ""}{r.value} {r.unit}</span>
              )) : "—"}
            </div>
          </div>
        </div>

        <div className="grid grid-cols-1 gap-4">
          <div className="h-[220px]">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={byDistrict}>
                <XAxis dataKey="district" stroke={LUNA.textMuted} tickLine={false} axisLine={{ stroke: LUNA.border }} />
                <YAxis stroke={LUNA.textMuted} tickLine={false} axisLine={{ stroke: LUNA.border }} />
                <Tooltip />
                <Bar dataKey="count" fill={LUNA.gold} radius={[6, 6, 0, 0]} />
              </BarChart>
            </ResponsiveContainer>
          </div>
          <div className="h-[220px]">
            <ResponsiveContainer width="100%" height="100%">
              <PieChart>
                <Pie data={exportMix} dataKey="value" nameKey="name" outerRadius={80}>
                  {exportMix.map((_, i) => (<Cell key={i} fill={pieColors[i % pieColors.length]} />))}
                </Pie>
                <Tooltip />
                <Legend />
              </PieChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div>
          <div className="text-xs text-zinc-400 mb-1">Top Buyers</div>
          <div className="flex gap-2 flex-wrap">
            {topBuyers.map(b => (
              <Badge key={b.buyer} className="bg-[#1b1b1b] text-zinc-300 border border-[#262626]">{b.buyer} · {b.count}</Badge>
            ))}
          </div>
        </div>
      </CardContent>
    </Card>
  );
};

// ANALYTICS ---------------------------------------------------
const CoopAnalytics: React.FC<{ data: Cooperative[] }> = ({ data }) => {
  const bySector = useMemo(() => {
    const m = new Map<string, number>();
    data.forEach((d) => m.set(d.sector, (m.get(d.sector) || 0) + 1));
    return Array.from(m, ([name, value]) => ({ name, value }));
  }, [data]);

  const membersByDistrict = useMemo(() => {
    const m = new Map<string, number>();
    data.forEach((d) => m.set(d.district, (m.get(d.district) || 0) + d.members));
    return Array.from(m, ([district, members]) => ({ district, members }));
  }, [data]);

  const capacityTrend = useMemo(() => {
    const points = data.map((d, i) => ({ month: `#${i + 1}`, capacity: d.capacity }));
    return points;
  }, [data]);

  const pieColors = [LUNA.gold, LUNA.orange, LUNA.soft, "#E9C46A", "#F4A261", "#F6BD60", "#E76F51"];

  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <Card>
        <CardHeader className="pb-2">
          <CardTitle className="text-sm">📊 Cooperatives by Sector</CardTitle>
        </CardHeader>
        <CardContent className="h-[260px]">
          <ResponsiveContainer width="100%" height="100%">
            <PieChart>
              <Pie dataKey="value" data={bySector} outerRadius={80}>
                {bySector.map((_, i) => (
                  <Cell key={i} fill={pieColors[i % pieColors.length]} />
                ))}
              </Pie>
              <Tooltip />
              <Legend />
            </PieChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>

      <Card>
        <CardHeader className="pb-2">
          <CardTitle className="text-sm">👥 Members by District</CardTitle>
        </CardHeader>
        <CardContent className="h-[260px]">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={membersByDistrict}>
              <XAxis dataKey="district" stroke={LUNA.textMuted} tickLine={false} axisLine={{ stroke: LUNA.border }} />
              <YAxis stroke={LUNA.textMuted} tickLine={false} axisLine={{ stroke: LUNA.border }} />
              <Tooltip />
              <Bar dataKey="members" fill={LUNA.gold} radius={[6, 6, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>

      <Card>
        <CardHeader className="pb-2">
          <CardTitle className="text-sm">📦 Capacity Sparkline</CardTitle>
        </CardHeader>
        <CardContent className="h-[260px]">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={capacityTrend}>
              <XAxis dataKey="month" stroke={LUNA.textMuted} tickLine={false} axisLine={{ stroke: LUNA.border }} />
              <YAxis stroke={LUNA.textMuted} tickLine={false} axisLine={{ stroke: LUNA.border }} />
              <Tooltip />
              <Line type="monotone" dataKey="capacity" stroke={LUNA.orange} dot={false} />
            </LineChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>
    </div>
  );
};

// NEW: ECOSYSTEM GRAPH ---------------------------------------
const EcosystemGraph: React.FC<{ data: Cooperative[]; onSelect: (id: string) => void; onSectorSelect: (sector: string) => void; onFDISelect: (priority: string) => void }> = ({ data, onSelect, onSectorSelect, onFDISelect }) => {
  // Build hubs from districts, sectors, and FDI priorities
  const hubsDistrict = Array.from(new Set(data.map(d => d.district))).map(d => ({ id: `District: ${d}`, type: 'hub-district', color: LUNA.orange }));
  const hubsSector = Array.from(new Set(data.map(d => d.sector))).map(s => ({ id: `Sector: ${s}`, type: 'hub-sector', color: LUNA.gold }));
  const hubsFDI = Array.from(new Set(data.map(d => d.fdiPriority))).map(p => ({ id: `FDI: ${p}`, type: 'hub-fdi', color: LUNA.soft }));

  const nodes = [
    ...hubsDistrict,
    ...hubsSector,
    ...hubsFDI,
    ...data.map(c => ({ id: c.id, label: c.cooperativeName, type: 'coop', color: '#fff', sector: c.sector }))
  ];
  const links: any[] = [];
  data.forEach(c => {
    links.push({ source: c.id, target: `District: ${c.district}` });
    links.push({ source: c.id, target: `Sector: ${c.sector}` });
    links.push({ source: c.id, target: `FDI: ${c.fdiPriority}` });
  });
  const graphData = { nodes, links } as any;

  // graph instance ref for centering/zoom-to-fit
  const fgRef = useRef<any>(null);

  // only auto-fit once per data change; don't fight user interactions
  const [autoFitPending, setAutoFitPending] = useState(true);

  // DRAG-TO-RESIZE (bottom-right handle)
  const [graphHeight, setGraphHeight] = useState(340);
  const MIN_H = 260;
  const MAX_H = 1200;

  const startDrag = (e: React.MouseEvent<HTMLDivElement>) => {
    e.preventDefault();
    const startY = e.clientY;
    const startH = graphHeight;
    const onMove = (ev: MouseEvent) => {
      const next = Math.min(MAX_H, Math.max(MIN_H, startH + (ev.clientY - startY)));
      setGraphHeight(next);
    };
    const onUp = () => {
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('mouseup', onUp);
      if (fgRef.current) {
        try { fgRef.current.zoomToFit(200, 20); } catch (e) {}
      }
    };
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onUp);
  };

  const GraphCanvas = ({ height }: { height: number }) => (
    <ForceGraph2D
      ref={fgRef}
      graphData={graphData}
      enableZoomPanInteraction={true}
      enablePointerInteraction={true}
      onEngineStop={() => { if (autoFitPending && fgRef.current) { try { fgRef.current.zoomToFit(400, 20); } catch (e) {} setAutoFitPending(false); } }}
      nodeRelSize={6}
      enableNodeDrag
      onNodeClick={(n: any) => {
        if (n.type === 'coop') onSelect(n.id);
        if (n.type === 'hub-sector') {
          const sector = String(n.id).replace(/^Sector: /, '');
          onSectorSelect(sector);
        }
        if (n.type === 'hub-fdi') {
          const priority = String(n.id).replace(/^FDI: /, '');
          onFDISelect(priority);
        }
      }}
      linkColor={() => "#3a3a3a"}
      linkDirectionalParticles={0}
      height={height}
      nodeCanvasObject={(node: any, ctx, globalScale) => {
        const isHub = node.type?.startsWith('hub');
        const radius = isHub ? 10 : 5;
        ctx.beginPath();
        ctx.arc(node.x, node.y, radius, 0, 2 * Math.PI, false);
        let fill = '#ffffff';
        if (isHub) {
          if (node.type === 'hub-district') fill = LUNA.orange;
          else if (node.type === 'hub-sector') fill = LUNA.gold;
          else if (node.type === 'hub-fdi') fill = LUNA.soft;
        }
        ctx.fillStyle = fill;
        ctx.fill();
        const label = isHub ? node.id.replace(/^.*?:\s*/, '') : node.label;
        const fontSize = isHub ? 4 + 4 / Math.sqrt(globalScale) : 3 + 3 / Math.sqrt(globalScale);
        ctx.font = `${fontSize}px sans-serif`;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = isHub ? '#e5e5e5' : '#a1a1aa';
        ctx.fillText(label, node.x + radius + 3, node.y);
      }}
    />
  );

  // Auto-fit once whenever the dataset size changes (don’t re-center while user is interacting)
  useEffect(() => {
    setAutoFitPending(true);
  }, [data.length]);

  return (
    <Card>
      <CardHeader className="flex items-center justify-between">
        <CardTitle className="text-sm">🕸️ Ecosystem Graph</CardTitle>
      </CardHeader>
      <CardContent className="relative p-0">
        <div style={{ height: graphHeight }}>
          <GraphCanvas height={graphHeight} />
        </div>
        <div
          role="button"
          aria-label="Resize graph"
          title="Drag to resize"
          onMouseDown={startDrag}
          className="absolute bottom-2 right-2 w-6 h-6 flex items-center justify-center rounded-md border cursor-nwse-resize select-none"
          style={{ borderColor: 'transparent', background: 'transparent', color: '#9ca3af', opacity: 0.85 }}
        >
          {/* Four-corner expand arrows */}
          <svg width="14" height="14" viewBox="0 0 16 16" aria-hidden="true">
            <g stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" fill="none">
              <path d="M6 6 L2 2"/>
              <path d="M2 5 L2 2 L5 2"/>
              <path d="M10 6 L14 2"/>
              <path d="M11 2 L14 2 L14 5"/>
              <path d="M6 10 L2 14"/>
              <path d="M2 11 L2 14 L5 14"/>
              <path d="M10 10 L14 14"/>
              <path d="M11 14 L14 14 L14 11"/>
            </g>
          </svg>
        </div>
      </CardContent>
    </Card>
  );
};

// TOP BAR -----------------------------------------------------
const TopBar: React.FC<{ total: number; onExport: () => void }> = ({ total, onExport }) => (
  <div className="flex items-center justify-between p-3 rounded-2xl border" style={{ borderColor: LUNA.border, background: "#111" }}>
    <div className="flex items-center gap-2">
      <div className="text-white font-semibold">Luna Maps — Cooperatives</div>
      <Badge className="bg-[#F9C74F] text-black">{total} results</Badge>
    </div>
    <div className="flex items-center gap-2">
      <Button variant="secondary" onClick={onExport}>Export CSV</Button>
    </div>
  </div>
);

// SELF TESTS --------------------------------------------------
function runSelfTests() {
  const out: { name: string; pass: boolean; message?: string }[] = [];

  // search across multiple fields
  const t1 = filterCoops(COOPS, { ...defaultCoopFilters(), q: "honey" }).some((c) => c.sector === "Honey");
  out.push({ name: "text search across fields", pass: t1 });

  // sector filter exact
  const t2 = filterCoops(COOPS, { ...defaultCoopFilters(), sector: "Aquaculture" }).every((c) => c.sector === "Aquaculture");
  out.push({ name: "sector filter", pass: t2 });

  // range filters
  const t3 = filterCoops(COOPS, { ...defaultCoopFilters(), minMembers: 90, maxMembers: 300 }).every((c) => c.members >= 90 && c.members <= 300);
  out.push({ name: "membership range", pass: t3 });

  // certification contains
  const t4 = filterCoops(COOPS, { ...defaultCoopFilters(), certification: "Organic" }).every((c) => c.certifications.includes("Organic"));
  out.push({ name: "certification filter", pass: t4 });

  // export history match
  const t5 = filterCoops(COOPS, { ...defaultCoopFilters(), exportHistory: "International" }).every((c) => c.exportHistory.includes("International"));
  out.push({ name: "export history filter", pass: t5 });

  // NEW: buyer exact filter
  const t6 = filterCoops(COOPS, { ...defaultCoopFilters(), buyer: "Belize Sea Co." }).every((c) => c.buyer === "Belize Sea Co.");
  out.push({ name: "buyer filter", pass: t6 });

  // NEW: FDI priority filter
  const t7 = filterCoops(COOPS, { ...defaultCoopFilters(), fdiPriority: "Blue Economy" }).every((c) => c.fdiPriority === "Blue Economy");
  out.push({ name: "FDI priority filter", pass: t7 });

  // NEW: capacity range filter
  const t8 = filterCoops(COOPS, { ...defaultCoopFilters(), minCapacity: 80, maxCapacity: 100 }).every((c) => c.capacity >= 80 && c.capacity <= 100);
  out.push({ name: "capacity range", pass: t8 });

  // NEW: combined Sector + FDI filter intersection
  const t9 = filterCoops(COOPS, { ...defaultCoopFilters(), sector: "Aquaculture", fdiPriority: "Agribusiness & Fisheries" })
    .every((c) => c.sector === "Aquaculture" && c.fdiPriority === "Agribusiness & Fisheries");
  out.push({ name: "sector + FDI intersection", pass: t9 });

  // NEW: text + district combo
  const t10 = filterCoops(COOPS, { ...defaultCoopFilters(), q: "reef", district: "Belize" })
    .every((c) => /reef/i.test(c.cooperativeName + " " + c.officialName) && c.district === "Belize");
  out.push({ name: "text + district combo", pass: t10 });

  return out;
}

// ROOT COMPONENT ---------------------------------------------
export default function LunaDashboard() {
  const [filters, setFilters] = useState<CoopFilters>(defaultCoopFilters());
  const [selectedId, setSelectedId] = useState<string | undefined>();

  // Focus dataset on Blue Economy only
  const base = useMemo(() => COOPS.filter(c => BLUE_SECTORS.includes(c.sector)), []);

  const data = useMemo(() => filterCoops(base, filters), [base, filters]);
  const selected = useMemo(() => COOPS.find((c) => c.id === selectedId), [selectedId]);
  const buyers = useMemo(() => Array.from(new Set(base.map((c) => c.buyer))).sort(), [base]);
  const tests = useMemo(runSelfTests, []);

  // Table anchor for smooth scroll after sector/FDI selection
  const tableRef = useRef<HTMLDivElement | null>(null);
  const handleSectorSelect = (sector: string) => {
    setFilters(prev => ({ ...prev, sector }));
    setTimeout(() => { tableRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 0);
  };
  const handleFDISelect = (priority: string) => {
    setFilters(prev => ({ ...prev, fdiPriority: priority }));
    setTimeout(() => { tableRef.current?.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, 0);
  };

  return (
    <div className="min-h-screen p-4 md:p-6" style={{ background: LUNA.bg, color: LUNA.text }}>
      <style>{`:root{--gold:${LUNA.gold};}`}</style>

      <TopBar total={data.length} onExport={() => exportCSV(data)} />

      <div className="grid grid-cols-1 xl:grid-cols-12 gap-5 mt-5">
        {/* Left: Filters */}
        <div className="xl:col-span-3">
          <Card>
            <CardHeader>
              <CardTitle className="text-sm">🧰 All Filters</CardTitle>
            </CardHeader>
            <CardContent>
              <FiltersPanel filters={filters} setFilters={setFilters} allBuyers={buyers} />
            </CardContent>
          </Card>
        </div>

        {/* Center: Graph + Analytics + Table */}
        <div className="xl:col-span-6 space-y-5">
          <EcosystemGraph data={data} onSelect={setSelectedId} onSectorSelect={handleSectorSelect} onFDISelect={handleFDISelect} />
          <CoopAnalytics data={data} />
          <div ref={tableRef} className="space-y-2">
            {filters.sector && (
              <div className="flex items-center justify-between px-1">
                <Badge className="bg-[#222] text-zinc-300 border border-[#262626]">Sector: {filters.sector}</Badge>
                <Button variant="ghost" onClick={() => { setFilters(prev => ({ ...prev, sector: undefined })); }}>
                  Show all sectors
                </Button>
              </div>
            )}
            {filters.fdiPriority && (
              <div className="flex items-center justify-between px-1">
                <Badge className="bg-[#222] text-zinc-300 border border-[#262626]">FDI: {filters.fdiPriority}</Badge>
                <Button variant="ghost" onClick={() => { setFilters(prev => ({ ...prev, fdiPriority: undefined })); }}>
                  Show all FDI
                </Button>
              </div>
            )}
        
